import sys
import json
import requests
import time

YELLOW = "\033[93m"
RESET = "\033[0m"

def extract_packages_from_json_content(content):
    data = json.loads(content)
    packages = []
    # بعض ملفات package-lock.json تستخدم key different
    # نحاول نقرأ من "dependencies" لو موجودة
    if "dependencies" in data:
        packages.extend(data["dependencies"].keys())
    # أو لو تريد دعم package.json التقليدي:
    for key in ("dependencies", "devDependencies"):
        if key in data:
            packages.extend(data[key].keys())
    return list(set(packages))  # ازالة التكرار

def check_package_npm(package_name):
    url = f"https://registry.npmjs.org/{package_name}"
    r = requests.get(url)
    if r.status_code == 404:
        print(f"{YELLOW}{package_name}{RESET}")

def main():
    if len(sys.argv) != 2:
        print(f"Usage: python {sys.argv[0]} <package-json-url>")
        sys.exit(1)

    url = sys.argv[1]

    try:
        response = requests.get(url)
        response.raise_for_status()
        packages = extract_packages_from_json_content(response.text)
        print(f"Found {len(packages)} packages. Checking if they exist on npm...\n")
        for pkg in packages:
            check_package_npm(pkg)
            time.sleep(0.2)  # احترام سيرفر npm
    except requests.RequestException as e:
        print("Error loading the file:", e)
    except json.JSONDecodeError:
        print("The file downloaded is not valid JSON.")

if __name__ == "__main__":
    main()
