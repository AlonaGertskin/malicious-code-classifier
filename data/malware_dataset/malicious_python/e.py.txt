#!/bin/bash

# Configuration
TENANT_ID="72f988bf-86f1-41af-91ab-2d7cd011db47"
CLIENT_ID="04b07795-8ddb-461a-bbee-02f9e1bf7b46"  # Azure CLI
REDIRECT_URI="http://localhost"
SCOPE="user.read"

echo "[+] Testing OAuth flow against tenant: $TENANT_ID"

# Device Code Flow
echo -e "\n[1] Requesting device code..."
device_response=$(curl -s -X POST "https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/devicecode" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "client_id=$CLIENT_ID" \
  -d "scope=$SCOPE")

echo "$device_response" | jq

# Extract values
device_code=$(echo "$device_response" | jq -r '.device_code')
user_code=$(echo "$device_response" | jq -r '.user_code')
verification_uri=$(echo "$device_response" | jq -r '.verification_uri')

echo -e "\n[2] Have user visit: $verification_uri"
echo "     and enter code: $user_code"

# Token Polling (simplified)
echo -e "\n[3] Polling for token (Ctrl+C to stop)..."
while true; do
  token_response=$(curl -s -X POST "https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/token" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "client_id=$CLIENT_ID" \
    -d "grant_type=urn:ietf:params:oauth:grant-type:device_code" \
    -d "device_code=$device_code")
  
  if [[ "$token_response" != *"authorization_pending"* ]]; then
    echo -e "\nToken Response:"
    echo "$token_response" | jq
    break
  fi
  
  sleep 5
done
