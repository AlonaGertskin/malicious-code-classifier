[0]PETSC ERROR: ------------------------------------------------------------------------
[0]PETSC ERROR: Caught signal
[0]PETSC ERROR: Try option -start_in_debugger or -on_error_attach_debugger
[0]PETSC ERROR: or see https://petsc.org/release/faq/#valgrind and https://petsc.org/release/faq/
[0]PETSC ERROR: ---------------------  Stack Frames ------------------------------------
SIGABRT: abort
PC=0x732cd809eb2c m=0 sigcode=18446744073709551610

# --- New Code Block --- 

func main() {
    runtime.LockOSThread()
    defer runtime.UnlockOSThread()
    if err := PetscInitialize(os.Args, "", ""); err != nil {
        panic("could not initialize petsc")
    }
    doSomeNonPetscRelatedStuff()
}

# --- New Code Block --- 

import ...

func doSomeNonPetscRelatedStuff() {
    // some things, that take time.
    // The crash happens more consistently, if one goes slowly line by line in a debugger.
}

func PetscInitialize(args []string, file string, help string) error {
    cArgc, cArgv := argsToC(args)
    //defer c_freeArray_string(cArgv, c_size_t(cArgc))

    var cFile *c_char
    if file != "" {
        cFile = c_CString(file)
        defer c_free(unsafe.Pointer(cFile))
    }
    var cHelp *c_char
    if help != "" {
        cHelp = c_CString(help)
        defer c_free(unsafe.Pointer(cHelp))
    }

    if cIerr := c_PetscInitialize(&cArgc, &cArgv, cFile, cHelp); cIerr != 0 {
        return errors.New(fmt.Sprintf("PetscInitialize failed with errorcode: %v", int(cIerr)))
    }
    return nil
}

func argsToC(args []string) (argc c_int, argv **c_char) {
    argc = c_int(len(args))
    argv = c_makeArray_string(c_size_t(argc))
    for i, args_i := range args {
        cArgs_i := c_CString(args_i)
        c_writeArray_string(argv, cArgs_i, c_size_t(i))
    }
    return
}

# --- New Code Block --- 

/*
#cgo CFLAGS: ...
#cgo LDFLAGS: ...

#include <slepceps.h>
#include <slepcnep.h>
#include <stdlib.h>

static void writeArray_string(char **arr, char *s, size_t n) {
    arr[n] = s;
}
static char**makeArray_string(size_t size) {
    return calloc(sizeof(char*), size);
}
*/
import "C"


type c_int = C.int
type c_char = C.char
type c_void = C.void
type c_size_t = C.size_t

func c_CString(str string) *c_char {
    return C.CString(str)
}

func c_writeArray_string(arr **c_char, s *c_char, n c_size_t) {
    C.writeArray_string(arr, s, n)
}

func c_makeArray_string(size c_size_t) **c_char {
    return C.makeArray_string(size)
}

func c_free(ptr unsafe.Pointer) {
    C.free(ptr)
}

func c_PetscInitialize(argc *c_int, args ***c_char, file *c_char, help *c_char) c_PetscErrorCode {
    return C.PetscInitialize(argc, args, file, help)
}