#include 
#include 
#include 

double cpu_usage = 0.0;
pthread_mutex_t lock;
volatile int running = 1;

double getCpuUsage() {
    FILE *f = fopen("/proc/stat", "r");
    if (!f) return -1;
    char buf[256];
    fgets(buf, sizeof(buf), f);
    fclose(f);

    unsigned long long user, nice, system, idle, iowait, irq, softirq;
    sscanf(buf, "cpu %llu %llu %llu %llu %llu %llu %llu",
           &user, &nice, &system, &idle, &iowait, &irq, &softirq);

    static unsigned long long prev_idle = 0, prev_total = 0;

    unsigned long long idle_now = idle + iowait;
    unsigned long long total_now = user + nice + system + idle + iowait + irq + softirq;
    unsigned long long diff_total = total_now - prev_total;
    unsigned long long diff_idle = idle_now - prev_idle;

    prev_idle = idle_now;
    prev_total = total_now;

    if (diff_total == 0) return 0.0;

    double usage = 100.0 * (diff_total - diff_idle) / (double)diff_total;
    printf("[getCpuUsage] internal calc: %.2f%%\n", usage);
    return usage;
}

void *cpu_thread(void *arg) {
    while (running) {
        pthread_mutex_lock(&lock);
        cpu_usage = getCpuUsage();
        pthread_mutex_unlock(&lock);
    }
    return NULL;
}

int main() {
    pthread_t t;
    pthread_mutex_init(&lock, NULL);

    getCpuUsage();

    pthread_create(&t, NULL, cpu_thread, NULL);

    for (int i = 0; i < 5; i++) {
        pthread_mutex_lock(&lock);
        printf("[main] shared cpu_usage: %.2f%%\n", cpu_usage);
        pthread_mutex_unlock(&lock);
        sleep(1);
    }

    running = 0;
    pthread_join(t, NULL);
    pthread_mutex_destroy(&lock);
}

# --- New Code Block --- 

[getCpuUsage] internal calc: 100.00%
[getCpuUsage] internal calc: 0.00%
[getCpuUsage] internal calc: 0.00%
[getCpuUsage] internal calc: 100.00%
[getCpuUsage] internal calc: 0.00%
[getCpuUsage] internal calc: 0.00%
[getCpuUsage] internal calc: 0.00%
[getCpuUsage] internal calc: 0.00%