date:13/88/12 day:0     Heure:4:22:4
date:13/88/12 day:0     Heure:4:22:8
date:13/88/12 day:0     Heure:4:22:8
date:13/88/12 day:0     Heure:4:22:9
date:13/88/12 day:0     Heure:4:22:9
date:13/88/12 day:0     Heure:4:22:10
date:13/88/12 day:0     Heure:4:22:10
date:13/88/12 day:0     Heure:4:22:11
date:13/88/12 day:0     Heure:4:22:11
date:13/88/12 day:0     Heure:4:22:12
date:13/88/12 day:0     Heure:4:22:12

# --- New Code Block --- 

0b10000000
0b10000000
0b10000011
0b10000011
0b10000000
0b10000000
0b10000011
0b10000011
0b10000100
0b10000100
0b10001000

# --- New Code Block --- 

#include "main.h"
#include "ds3234.h"
#include "stdio.h"
#include "string.h"

#define SIZE_MSG 255

SPI_HandleTypeDef hspi1;
UART_HandleTypeDef huart2;
char msg[SIZE_MSG+1];

void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_SPI1_Init(void);
static void MX_USART2_UART_Init(void);

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  HAL_Init();
  SystemClock_Config();
  MX_GPIO_Init();
  MX_SPI1_Init();
  MX_USART2_UART_Init();
  DS3234_Init(&hspi1);
  _RTC now = {.Sec = 59, .Min = 34, .Hour = 9, .Date = 27,.Day = 5, .Month = 10, .Year = 25};


  uint8_t status;
  status = DS3234_SetTime(&now);
  memset(msg,0,SIZE_MSG);
  snprintf(msg, SIZE_MSG, "status : %d\r\n",status);
  HAL_UART_Transmit(&huart2, (uint8_t*)msg, SIZE_MSG, HAL_MAX_DELAY);

  while (1)
  {
      status = DS3234_GetTime(&now);
      memset(msg,0,SIZE_MSG);
      snprintf(msg, SIZE_MSG, "date:%d/%d/%d day:%d\tHeure:%d:%d:%d\r\n",now.Date,now.Month,(now.Year)+2000,now.Day,now.Hour,now.Min,now.Sec);
      HAL_UART_Transmit(&huart2, (uint8_t*)msg, SIZE_MSG, HAL_MAX_DELAY);
      HAL_Delay(1000);

  }

}

# --- New Code Block --- 

uint8_t DS3234_GetTime(_RTC *rtc)
{
    uint8_t addr = DS3234_REG_SEC & 0x7F;
    uint8_t buffer[7];
    DS3234_Select();
    HAL_SPI_Transmit(hspi_ds3234, &addr, 1, HAL_MAX_DELAY);
    HAL_SPI_Receive(hspi_ds3234, buffer, 7, HAL_MAX_DELAY);
    DS3234_Unselect();

    rtc->Sec   = B2D(buffer[0] & 0x7F);
    rtc->Min   = B2D(buffer[1] & 0x7F);
    rtc->Hour  = B2D(buffer[2] & 0x3F);
    rtc->Day   = buffer[3] & 0x07;
    rtc->Date  = B2D(buffer[4] & 0x3F);
    rtc->Month = B2D(buffer[5] & 0x9F);
    rtc->Year  = B2D(buffer[6]);


    return HAL_OK;
}

# --- New Code Block --- 

uint8_t DS3234_SetTime(_RTC *rtc)
{
    DS3234_WriteRegister(DS3234_REG_SEC,   (D2B(rtc->Sec) & 0x7F));
    DS3234_WriteRegister(DS3234_REG_MIN,   (D2B(rtc->Min) & 0x7F));
    DS3234_WriteRegister(DS3234_REG_HOUR,  (D2B(rtc->Hour)& 0x3F));
    DS3234_WriteRegister(DS3234_REG_DAY,   rtc->Day & 0x07);
    DS3234_WriteRegister(DS3234_REG_DATE,  (D2B(rtc->Date) & 0x3F));
    DS3234_WriteRegister(DS3234_REG_MONTH, (D2B(rtc->Month)& 0x9F));
    DS3234_WriteRegister(DS3234_REG_YEAR,  D2B(rtc->Year));
    return HAL_OK;
}

# --- New Code Block --- 

void DS3234_WriteRegister(uint8_t reg, uint8_t value)
{
    uint8_t addr = reg|0x80;

    DS3234_Select();
    HAL_SPI_Transmit(hspi_ds3234, &addr, 1, HAL_MAX_DELAY);
    HAL_SPI_Transmit(hspi_ds3234, &value, 1, HAL_MAX_DELAY);
    DS3234_Unselect();
}

# --- New Code Block --- 

void DS3234_Init(SPI_HandleTypeDef *hspi)
{
    hspi_ds3234 = hspi;
    uint8_t txbuff[2] = {DS3234_CONTROL_REG, 0x3D};
    DS3234_Select();
    HAL_SPI_Transmit(hspi_ds3234,txbuff,2,HAL_MAX_DELAY);
    DS3234_Unselect();
}

# --- New Code Block --- 

static uint8_t B2D(uint8_t bcd)
{
    return ((bcd >> 4) * 10 + (bcd & 0x0F));
}

static uint8_t D2B(uint8_t decimal)
{
    return (((decimal / 10) << 4) | (decimal % 10));
}

# --- New Code Block --- 

hspi1.Init.CLKPolarity = SPI_POLARITY_HIGH;
  hspi1.Init.CLKPhase = SPI_PHASE_2EDGE;"