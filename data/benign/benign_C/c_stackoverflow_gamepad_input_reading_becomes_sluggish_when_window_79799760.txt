#include <stdint.h>
#include <stdbool.h>
#include <windows.h>
#include "joystick.h"
#include <SDL2/SDL.h>
#include <stdio.h>



SDL_Event event;
int quit = 0;
int16_t rx, ry;


void JOYSTICK_Quit(void);

SDL_GameController* controller = NULL;


uint8_t JOYSTICK_Init()
{
    SDL_SetHint(SDL_HINT_JOYSTICK_THREAD, "1");
    SDL_SetHint(SDL_HINT_JOYSTICK_ALLOW_BACKGROUND_EVENTS,"1");

        
    if (SDL_Init(SDL_INIT_GAMECONTROLLER) < 0) {
        fprintf(stderr, "SDL could not initialize! SDL Error: %s\n", SDL_GetError());
        return 1;
    }

    printf("SDL initialized successfully.\n");

    controller = SDL_GameControllerOpen(0);
}

uint8_t JOYSTICK_check()
{
    if(SDL_NumJoysticks() < 1){
        return 1; 
    }else{
        return 0; //joystick connected
    }
}

void JOYSTICK_Quit(void)
{
    SDL_Quit();
}

void handle_joystick_event(const SDL_Event* event) {

    if (event->type == SDL_CONTROLLERAXISMOTION){
           printf("%s %d axis %d moved to value: %d\n", SDL_GameControllerName(controller), event->caxis.which, event->caxis.axis, event->caxis.value);

           if(event->caxis.axis == SDL_CONTROLLER_AXIS_RIGHTX)
                if(event->caxis.value > 6000 || event->caxis.value < -6000)
                    rx = event->caxis.value;
                else
                    rx = 0;
                
            if(event->caxis.axis == SDL_CONTROLLER_AXIS_RIGHTY)
                if(event->caxis.value > 6000 || event->caxis.value < -6000)
                    ry = event->caxis.value;
                else
                    ry = 0;
    }
}

void JOYSTICK_UPDATE(){
    while (SDL_PollEvent(&event) != 0) {
            handle_joystick_event(&event);
    }
}