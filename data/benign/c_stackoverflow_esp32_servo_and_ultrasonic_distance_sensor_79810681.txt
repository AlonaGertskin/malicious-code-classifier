//  servo
#include <ESP32Servo.h>
#define PIN_SG90 22

const int minPulse = 500; //minimum pulse width for servo 0.5ms
const int maxPulse = 2500; // maximum pulse width 2.5ms

Servo sg90;


//  ultrasonic pinout
const int echo_pin = 17;
const int trig_pin = 16;

const int b34 = 34;
const int b35 = 35;


//  convert to cm
int cm = 0;

//  boolean for interrupts
bool measure = false;


//  functionn for ultrasonic distance sensor
void uds(){
  float timing = 0.0;

  digitalWrite(trig_pin, LOW);
  delay(50);

  digitalWrite(trig_pin, HIGH);
  delay(100);
  digitalWrite(trig_pin, LOW);

  timing = pulseIn(echo_pin, HIGH);

  float cm = 0.01723 * timing;
  Serial.print("Cm: ");
  Serial.println(cm);
  delay(100);

}


//  state initials
enum ScanState { stopped, forward, reverse };
ScanState scanState = stopped;
unsigned long lastServoUpdate = 0;
int currentAngle = 0;

//  servo sg90 scanning state machine
void scan() {
  unsigned long currentMillis = millis();
  
  if (currentMillis - lastServoUpdate >= 10) {
    lastServoUpdate = currentMillis;
    
    switch (scanState) {
      case forward:
        currentAngle++;
        if (currentAngle >= 180) {
          scanState = reverse;
        }
        break;
        
      case reverse:
        currentAngle--;
        if (currentAngle <= 0) {
          scanState = forward;
        }
        break;
        
      case stopped:
        // Servo remains at current position
        return;
    }
    
    int pulse = map(currentAngle, 0, 180, minPulse, maxPulse);
    sg90.writeMicroseconds(pulse);
  }
}



//  stop function
void stop(){
  Serial.println("Press button34 to start again:");
  sg90.write(0);
  measure = false;
  scanState = stopped;
}

//  start function
void start(){
  measure = true;
  scanState = forward;
  currentAngle = 0;
}



void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  sg90.setPeriodHertz(150);
  sg90.attach(PIN_SG90, minPulse, maxPulse); //set pulse width range set
  Serial.begin(9600);
  sg90.write(0);
  delay(400);


  //  Ultrasonic pins
  pinMode(echo_pin, INPUT);
  pinMode(trig_pin, OUTPUT);
  //button pins
  pinMode(b34, INPUT_PULLUP);
  pinMode(b35, INPUT_PULLUP);

  digitalWrite(echo_pin, LOW);
  digitalWrite(b34, LOW);
  digitalWrite(b35, LOW);

  //  interrupts
  attachInterrupt(digitalPinToInterrupt(b35), stop, RISING);
  attachInterrupt(digitalPinToInterrupt(b34), start, RISING);


  


}

void loop() {
  // put your main code here, to run repeatedly:

  if (measure == true){
    scan();

    
  }


}

# --- New Code Block --- 

sg90.setPeriodHertz(150);