def spawn_with_pty():
    master_fd, slave_fd = pty.openpty()
    proc = subprocess.Popen(SSH_COMMAND,
                            stdin=slave_fd,
                            stdout=slave_fd,
                            stderr=slave_fd,
                            text=True,
                            close_fds=True)
    os.close(slave_fd)
    return proc, master_fd


def write_to_master(master_fd, text):
    os.write(master_fd, text.encode())


def main():
    try:
        process, master_fd = spawn_with_pty()
        time.sleep(2)
        write_to_master(master_fd, PASSWORD + '\n')
        time.sleep(2)
        otp = generate_otp()
        write_to_master(master_fd, otp + '\n')
        process.wait()
    except KeyboardInterrupt:
        print("Connection closed by user.")
        os.close(master_fd)
        process.terminate()
    except Exception as e:
        print("SOMETHING WENT WRONG")
        
if __name__ == "__main__":
    main()