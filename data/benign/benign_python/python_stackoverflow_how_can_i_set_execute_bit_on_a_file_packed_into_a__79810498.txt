// Get current date and time
  QDateTime dateTime = QDateTime::currentDateTime();
  QDate date = dateTime.date();
  QTime time = dateTime.time();

  QString timeStr = time.toString("HHmmss");
  QString dateStr = date.toString("yyyyMMdd");

  QString folderName = "Simulation_" + dateStr + "T" + timeStr;
  QString suggestedPath = "./" + folderName ;

  // Get the location and name of the tar file the user wants to create
  QString path =
      QFileDialog::getSaveFileName(this, tr("Save Tarfile"), suggestedPath,
                                   tr("Package (*.tar.gz)"));

  QFileInfo tarInfo(path);
  QString tarPath = tarInfo.absolutePath();
  QString simFolderName = tarInfo.baseName();
  QString simPath = QDir(tarPath).filePath(simFolderName);

  // (Various files are added to the temporary folder here)
  // I cannot show SO which specific files

  // Zip up the simulation folder
  QString archiveName = simPath + ".tar.gz";
  py::module tarModule = py::module::import("tarfile");
  py::object tarFileObj =
      tarModule.attr("open")(archiveName.toStdString(), "w:gz");
  tarFileObj.attr("add")(simPath.toStdString(), simFolderName.toStdString());
  tarFileObj.attr("close")();

  // Delete the temporary folder
  QDir simDir(simPath);
  simDir.removeRecursively();

# --- New Code Block --- 

def fixMode(info):
      # The execute bit is often not handled correctly on Windows (e.g., when
      # using WSL and packaging from a Windows-hosted folder).
      if not (info.mode & S_IXUSR):
        oldmode = info.mode
        if (info.name.lower().endswith(DEF_PBSEXTN) or
            info.name.lower().endswith('.py') or
            info.name.lower().endswith('.sh')):
          info.mode |= S_IXUSR
        else:
          with open(self.jobfolder + info.name[len(self.jobname):], 'rb') as f:
            if f.read(2) == b'#!':
              # Assume any file starting with shebang should be executable.
              info.mode |= S_IXUSR
        if oldmode != info.mode:
          print(f'{oldmode:o}', f'{info.mode:o}', info.name)
      return info

# --- New Code Block --- 

tar.add(self.jobfolder, self.jobname, filter=fixMode)

# --- New Code Block --- 

// Set the execute permissions on the main run script
  QString runScript = simPath + "/run.sh";
  std::string runScriptStd = runScript.toStdString();
  struct stat fileStat;
  stat(runScriptStd.c_str(), &fileStat);
  mode_t newMode = fileStat.st_mode | S_IXUSR;
  chmod(runScriptStd.c_str(), newMode);

# --- New Code Block --- 

py::object tarFileObj = tarModule.attr("open")(archiveName.toStdString(), "w:gz");
  py::object tarInfoObj = tarFileObj.attr("gettarinfo")(simPath.toStdString() + "/run.sh");
  py::object tarInfoModeObj = tarInfoObj.attr("mode");
  tarInfoModeObj |= statModule.attr("S_IXUSR");
  tarFileObj.attr("add")(simPath.toStdString(),simFolderName.toStdString());